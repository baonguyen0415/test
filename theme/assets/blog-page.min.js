(()=>{var l=class extends HTMLElement{constructor(){super();this.isLoading=!1,this.initEventHandler()}initEventHandler(){let e=t=>{let n=this;return function(s){let a=n.getBoundingClientRect(),r=n.getInfo();!n.isLoading&&r.nextPage&&window.pageYOffset+1e3>=a.y&&t()}};Object.assign(this,{unobserver:()=>{window.removeEvent("scroll",this.scrollHandler),this.removeEvent("click",this.scrollHandler)},observer(t){this.scrollHandler=e(t),this.unobserver(),window.addEvent("scroll",this.scrollHandler),this.addEvent("click",this.scrollHandler)}})}reset(){this.setAttribute("data-current-page",1),this.setAttribute("data-next-page",1)}setStatus(e){switch(e){case"hide":this.addClass("d-none");break;case"show":this.removeClass("d-none");break;case"loading":this.setAttribute("loading",""),this.isLoading=!0;break;case"loaded":this.removeAttribute("loading"),this.isLoading=!1;break;case"reset":this.setAttribute("data-current-page",1),this.setAttribute("data-next-page",1);break}}setInfo({currentPage:e,nextPage:t}){this.setAttribute("data-current-page",e),this.setAttribute("data-next-page",t)}getInfo(){return{currentPage:+this.getAttribute("data-current-page"),nextPage:+this.getAttribute("data-next-page")}}};var c={onLoad(){this.filterData=[],this.elms={infiniteButton:this.container.querySelector("infinite-button"),blogGridContainer:this.container.querySelector("#main-blog-grid"),tagElements:this.container.querySelectorAll(".js-tag"),paginationContainer:document.getElementById("pagination-container")},this.settings=JSON.parse(this.container.querySelector("script[data-blog-settings]").innerHTML),this.filterData={},this.canceLoadArticles=!1,this.settings.paginationType=="infinite"&&this.loadArticles().then(()=>this.initInfiniteButton()),this.initFilter()},initFilter(){let{tagElements:i}=this.elms,e=i[0].closest(".widget-tags");i.forEach(t=>{t.addEvent("click",n=>{n.preventDefault();let{tagHandle:s}=t.dataset,a=!1;t.hasClass("active")?(a=!0,this.settings.currentTags=this.settings.currentTags.filter(r=>r!=s)):this.settings.currentTags.push(s),this.canceLoadArticles=!0,e.addClass("pending"),this.updatePage("filter").then(()=>{a?t.removeClass("active"):t.addClass("active")}).catch(r=>{console.warn("Tag filter has an error:"),console.warn(r)}).finally(()=>{this.canceLoadArticles=!1,e.removeClass("pending")})})})},initInfiniteButton(){let{infiniteButton:i,paginationContainer:e}=this.elms;customElements.define("infinite-button",l);let{nextPage:t}=i.getInfo();t&&(i.observer(this.onInfiniteHandler.bind(this)),e.removeClass("d-none"))},onInfiniteHandler(){let{infiniteButton:i}=this.elms,{currentPage:e,nextPage:t}=i.getInfo();if(t){e++;let n=this.getSearchParams(e);i.setStatus("loading"),this.updatePage("infinite",n).then(()=>i.setStatus("loaded"))}},async loadArticles(){let i=AT.getParameterByName("page")||1;for(let e=1;e<=i;e++){let t=this.getSearchParams(e);if(this.canceLoadArticles){this.canceLoadArticles=!1;break}await this.updatePage("load-articles",t)}},async updatePage(i,e){!e&&(e=this.getSearchParams());let t=`${this.settings.url}${e}`;return new Promise((n,s)=>{try{AT.queue.add(this.getPage(t),a=>{this.renderPage(i,a),this.updateURLHash(t),n(1)})}catch(a){s(a)}})},getPage(i){return this.filterData[i]?this.filterData[i].cloneNode(!0):fetch(i,{dataType:"text"}).then(e=>{let t=document.createElement("div");return t.innerHTML=e,this.filterData[i]=t.cloneNode(!0),t})},async renderPage(i,e){let{blogGridContainer:t,paginationContainer:n,infiniteButton:s}=this.elms,a=[...e.querySelectorAll("#main-blog-grid article")];switch(i){case"filter":await AT.scrollTo(t,1e3,parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--header-height"))+40).then(()=>{t.innerHTML=e.querySelector("#main-blog-grid").innerHTML,this.settings.paginationType!="infinite"&&(n.innerHTML=e.querySelector("#pagination-container").innerHTML.replace(/&view=ajax/g,"").replace(/&amp;view=ajax/g,""))});break;case"infinite":case"load-articles":a.forEach(r=>t.append(r));break}if(this.settings.paginationType=="infinite"&&i!="load-articles"){let{currentPage:r,nextPage:o}=e.querySelector("infinite-button").dataset;+o?(n.removeClass("d-none"),s.observer(this.onInfiniteHandler.bind(this))):(n.addClass("d-none"),s.unobserver()),s.setInfo({currentPage:r,nextPage:o})}},getSearchParams(i){return[this.settings.currentTags.length?`/tagged/${this.settings.currentTags.join("+")}`:"",[`page=${i||1}`,"view=ajax"].join("&")].join("?")},updateURLHash(i){history.pushState({},"",i.replace("&view=ajax",""))}};register("blog-template",c);load("blog-template");})();
