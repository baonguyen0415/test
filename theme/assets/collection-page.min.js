(()=>{var u=class extends HTMLElement{constructor(){super();this.isLoading=!1,this.initEventHandler()}initEventHandler(){let t=i=>{let n=this;return function(r){let a=n.getBoundingClientRect(),s=n.getInfo();!n.isLoading&&s.nextPage&&window.pageYOffset+1e3>=a.y&&i()}};Object.assign(this,{unobserver:()=>{window.removeEvent("scroll",this.scrollHandler),this.removeEvent("click",this.scrollHandler)},observer(i){this.scrollHandler=t(i),this.unobserver(),window.addEvent("scroll",this.scrollHandler),this.addEvent("click",this.scrollHandler)}})}reset(){this.setAttribute("data-current-page",1),this.setAttribute("data-next-page",1)}setStatus(t){switch(t){case"hide":this.addClass("d-none");break;case"show":this.removeClass("d-none");break;case"loading":this.setAttribute("loading",""),this.isLoading=!0;break;case"loaded":this.removeAttribute("loading"),this.isLoading=!1;break;case"reset":this.setAttribute("data-current-page",1),this.setAttribute("data-next-page",1);break}}setInfo({currentPage:t,nextPage:i}){this.setAttribute("data-current-page",t),this.setAttribute("data-next-page",i)}getInfo(){return{currentPage:+this.getAttribute("data-current-page"),nextPage:+this.getAttribute("data-next-page")}}};var h={onLoad(){let{container:e}=this;this.elms={sortBy:e.querySelector("#select-sort-by"),productGridContainer:e.querySelector("#main-collection-product-grid"),filterGroups:e.getElementsByClassName("js-filter-group"),productsShowing:e.querySelector("#products-showing"),filterValueCountElements:e.querySelectorAll("#collection-filters-form .js-count"),infiniteButton:e.querySelector("infinite-button"),sidebarContainer:e.querySelector("#main-collection-filters"),paginationContainer:e.querySelector("#pagination-container")},this.canceLoadProducts=!1,this.filterData={},this.settings=JSON.parse(this.container.querySelector("script[data-collection-settings]").innerHTML),this.filterActiveValues=this.getFilterActiveValues(),this.settings.paginationType=="infinite"&&this.loadProducts().then(()=>this.initInfiniteButton()),this.initFilter(),this.initSortBy(),this.initSidebarSticky()},initSortBy(){if(this.settings.enableSort){let{sortBy:e}=this.elms;e.addEvent("change",()=>{this.settings.paginationType=="infinite"?this.loadProducts("sort-by"):this.updatePage("sort-by")})}},initFilter(){let{filterGroups:e}=this.elms;e.forEach(t=>{let{paramName:i}=t.dataset;t.querySelectorAll("input").addEvents("input",n=>{let r=n.target;t.setAttribute("pending",""),r.checked?this.filterActiveValues[i].push(r.value):this.filterActiveValues[i]=this.filterActiveValues[i].filter(a=>a!=r.value),this.canceLoadProducts=!0,this.updatePage("filter").then(()=>{t.removeAttribute("pending"),this.canceLoadProducts=!1})})})},initInfiniteButton(){let{infiniteButton:e,paginationContainer:t}=this.elms;!customElements.get("infinite-button")&&customElements.define("infinite-button",u),e.getInfo().nextPage&&(e.observer(this.onInfiniteHandler.bind(this)),t.removeClass("d-none"))},onInfiniteHandler(){let{infiniteButton:e}=this.elms,{nextPage:t,currentPage:i}=e.getInfo();if(t){i++;let n=this.getSearchParams("infinite",i);e.setStatus("loading"),this.updatePage("infinite",n).then(()=>e.setStatus("loaded"))}},async loadProducts(e){let t=+this.getPageNumber();for(let i=1;i<=t;i++){let n=this.getSearchParams("load-products",i);if(this.canceLoadProducts){this.canceLoadProducts=!1;break}await this.updatePage("load-products",n,i,e)}},async updatePage(e,t,i,n){return!t&&(t=this.getSearchParams(e)),new Promise((r,a)=>{AT.queue.add(this.getPage(t),s=>{switch(e){case"sort-by":{this.renderPage(s,e),this.updateURLHash(t);break}case"filter":{this.renderPage(s,e),this.updateURLHash(t);break}case"load-products":{this.renderPage(s,e,i,n),n=="sort-by"&&this.updateURLHash(t);break}case"infinite":{this.renderPage(s,e),this.updateURLHash(t);break}}r(1)})})},async renderPage(e,t,i,n){let{productGridContainer:r,filterValueCountElements:a,paginationContainer:s,productsShowing:l,infiniteButton:d}=this.elms;switch(t){case"sort-by":r.innerHTML=e.querySelector("#main-collection-product-grid").innerHTML,this.settings.paginationType!=="infinite"&&(s.innerHTML=e.querySelector("#pagination-container").innerHTML.replace(/&view=ajax/g,"").replace(/&amp;view=ajax/g,""));break;case"filter":await AT.scrollTo(0,1e3).then(()=>{r.innerHTML=e.querySelector("#main-collection-product-grid").innerHTML,JSON.parse(e.querySelector("script[filter-values-counts]").innerHTML).filter(Boolean).forEach((o,c)=>{a[c].innerHTML=o}),!!l&&(l.innerHTML=e.querySelector("#products-showing").innerHTML),this.settings.paginationType!=="infinite"&&(s.innerHTML=e.querySelector("#pagination-container").innerHTML.replace(/&view=ajax/g,"").replace(/&amp;view=ajax/g,""))});break;case"infinite":!!l&&(l.innerHTML=e.querySelector("#products-showing").innerHTML);case"load-products":n=="sort-by"&&i==1&&(r.innerHTML=""),e.querySelectorAll("product-card").forEach(o=>r.append(o))}if(this.settings.paginationType==="infinite"&&t!="load-products"){let{currentPage:o,nextPage:c}=e.querySelector("infinite-button").dataset;+c?(s.removeClass("d-none"),d.observer(this.onInfiniteHandler.bind(this))):(s.addClass("d-none"),d.unobserver()),d.setInfo({currentPage:o,nextPage:c})}},getSearchParams(e,t){let{sortBy:i}=this.elms,n=[AT.getParameterByName("q")?`q=${AT.getParameterByName("q")}`:"",...Object.keys(this.filterActiveValues).reduce((r,a)=>(this.filterActiveValues[a].length&&r.push(`${a}=${this.filterActiveValues[a].map(encodeURIComponent).join(",")}`),r),[]),i?`sort_by=${i.value}`:""];switch(e){case"sort-by":n.push(`page=${this.getPageNumber()}`);break;case"infinite":case"load-products":n.push(`page=${t}`);break}return n.push("view=ajax"),n.filter(Boolean).join("&")},getPage(e){let t=`${window.location.pathname}?${e}`;return this.filterData[t]?this.filterData[t].cloneNode(!0):fetch(t,{dataType:"text"}).then(i=>{let n=document.createElement("div");return n.innerHTML=i,this.filterData[t]=n.cloneNode(!0),n})},getPageNumber(){return AT.getParameterByName("page")||1},updateURLHash(e){history.pushState({},"",`${window.location.pathname}${e&&"?".concat(e.replace("&view=ajax",""))}`)},initSidebarSticky(){let{sidebarContainer:e,productGridContainer:t}=this.elms,i=e.offsetHeight,n=parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--header-height"));window.addEvent("scroll",()=>{let{top:r,bottom:a}=this.container.getBoundingClientRect();r<window.pageYOffset+n&&i>window.innerHeight-(n+30)&&a>window.innerHeight&&t.offsetHeight>i?e.css("max-height",window.innerHeight-(n+30)+"px"):e.css("max-height","")})},getFilterActiveValues(){let e=JSON.parse(this.container.querySelector("script[data-collection-filter-active-values]").innerHTML);return window.location.search.replace("?","").split("&").forEach(t=>{let[i,n]=t.split(/=(.+)/);i in e&&n&&!e[i].includes(n)&&e[i].push(n)}),e}};register("collection-template",h);load("collection-template");console.log("collection-page.js loaded");})();
